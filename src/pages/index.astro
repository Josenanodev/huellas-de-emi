---
import Layout from "../layouts/Layout.astro";
import type { Dog } from "../types";

let dogs: Dog[] = [];
let errorMessage = '';

try {
  const dogsApiUrl = new URL("/api/dogs", Astro.url).toString();
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 8000);
  
  const response = await fetch(dogsApiUrl, { signal: controller.signal });
  clearTimeout(timeoutId);
  
  const data: unknown = await response.json();
  dogs = Array.isArray(data) ? data : [];
} catch (error) {
  console.error("Failed to load dogs on homepage:", error);
  errorMessage = 'No se pudieron cargar los perros en este momento. Por favor, intenta m치s tarde.';
}
---

<Layout title="Inicio">
  <div class="container">
    <h1>游 Perros en Adopci칩n</h1>
    <p>Conoce a nuestros adorables perros que est치n buscando un hogar lleno de amor.</p>

    {errorMessage && (
      <div style="padding: 1rem; background: #fee; border: 1px solid #c33; border-radius: 4px; margin: 1rem 0;">
        <p style="margin: 0; color: #c33;">{errorMessage}</p>
      </div>
    )}

    {
      dogs.length === 0 && !errorMessage ? (
        <p>No hay perros disponibles en este momento.</p>
      ) : (
        <div class="dogs-grid">
          {dogs.map((dog) => (
            <div class="dog-card">
              <img
                src={dog.images[0] || "/images/default-dog.svg"}
                alt={dog.name}
                class="dog-image"
              />
              <div class="dog-info">
                <h2 class="dog-name">{dog.name}</h2>
                <p class="dog-breed">{dog.breed}</p>
                <p>
                  <span class={`dog-status status-${dog.status}`}>
                    {dog.status === "available" && "Disponible"}
                    {dog.status === "adopted" && "Adoptado"}
                    {dog.status === "in_treatment" && "En Tratamiento"}
                    {dog.status === "reserved" && "Reservado"}
                  </span>
                </p>
                <p>{dog.description.substring(0, 100)}...</p>
                <a href={`/dog/${dog._id}`} class="btn">
                  Ver m치s
                </a>
              </div>
            </div>
          ))}
        </div>
      )
    }
  </div>
</Layout>
