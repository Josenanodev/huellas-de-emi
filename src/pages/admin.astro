---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Admin">
  <div class="container">
    <div class="admin-container">
      <div id="login-section">
        <h1>Panel de Administración</h1>
        <div class="form-group">
          <label for="admin-password">Contraseña de Administrador</label>
          <input type="password" id="admin-password" placeholder="Ingrese contraseña" />
        </div>
        <button id="login-btn" class="btn">Iniciar Sesión</button>
        <div id="auth-message"></div>
      </div>

      <div id="admin-panel" style="display: none;">
        <div class="admin-header">
          <h1>Gestionar Perros</h1>
          <button id="logout-btn" class="btn btn-secondary">Cerrar Sesión</button>
        </div>

        <div id="admin-message"></div>

        <div id="dog-form-section">
          <h2 id="form-title">Agregar Nuevo Perro</h2>
          <form id="dog-form">
            <input type="hidden" id="dog-id" />

            <div class="form-group">
              <label for="name">Nombre *</label>
              <input type="text" id="name" name="name" required />
            </div>

            <div class="form-group">
              <label for="breed">Raza *</label>
              <input type="text" id="breed" name="breed" required />
            </div>

            <div class="form-group">
              <label for="age">Edad (años) *</label>
              <input type="number" id="age" name="age" min="0" required />
            </div>

            <div class="form-group">
              <label for="gender">Género *</label>
              <select id="gender" name="gender" required>
                <option value="">Seleccionar...</option>
                <option value="male">Macho</option>
                <option value="female">Hembra</option>
              </select>
            </div>

            <div class="form-group">
              <label for="size">Tamaño *</label>
              <select id="size" name="size" required>
                <option value="">Seleccionar...</option>
                <option value="small">Pequeño</option>
                <option value="medium">Mediano</option>
                <option value="large">Grande</option>
              </select>
            </div>

            <div class="form-group">
              <label for="status">Estado *</label>
              <select id="status" name="status" required>
                <option value="available">Disponible</option>
                <option value="reserved">Reservado</option>
                <option value="in_treatment">En Tratamiento</option>
                <option value="adopted">Adoptado</option>
              </select>
            </div>

            <div class="form-group">
              <label for="description">Descripción *</label>
              <textarea id="description" name="description" required></textarea>
            </div>

            <div class="form-group">
              <label for="personality">Personalidad</label>
              <textarea id="personality" name="personality"></textarea>
            </div>

            <div class="form-group">
              <label for="specialCare">Cuidados Especiales</label>
              <textarea id="specialCare" name="specialCare"></textarea>
            </div>

            <div class="form-group">
              <label for="healthConditions"
                >Condiciones de Salud (separadas por coma)</label
              >
              <input
                type="text"
                id="healthConditions"
                name="healthConditions"
                placeholder="Ej: Displasia, Artritis"
              />
            </div>

            <div class="form-group-row">
              <label>
                <input type="checkbox" id="vaccinated" name="vaccinated" />
                Vacunado
              </label>
            </div>

            <div class="form-group-row">
              <label>
                <input type="checkbox" id="sterilized" name="sterilized" />
                Esterilizado
              </label>
            </div>

            <div class="form-group">
              <label for="images">URLs de Imágenes (separadas por coma)</label>
              <input
                type="text"
                id="images"
                name="images"
                placeholder="Ej: http://ejemplo.com/img1.jpg, http://ejemplo.com/img2.jpg"
              />
            </div>

            <div class="form-group" id="existing-images-section" style="display: none;">
              <label>Imágenes Actuales</label>
              <div
                id="existing-images"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 0.5rem;"
              >
              </div>
              <small
                id="delete-images-legend"
                style="display: none; margin-top: 0.5rem; color: var(--primary-dark);"
              >
                Guarde los cambios para eliminar imagenes
              </small>
            </div>

            <div class="form-group">
              <label for="image-files">O Subir Imágenes desde tu Computadora</label>
              <input
                type="file"
                id="image-files"
                accept="image/jpeg,image/jpg,image/png,image/webp"
                multiple
              />
              <small
                style="display: block; margin-top: 0.5rem; color: var(--primary-dark);"
              >
                Formatos permitidos: JPG, PNG, WebP. Tamaño máximo: 5MB por imagen.
              </small>
              <div
                id="image-preview"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; margin-top: 1rem;"
              >
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn" id="submit-btn">Guardar</button>
              <button type="button" class="btn btn-secondary" id="cancel-btn"
                >Cancelar</button
              >
            </div>
          </form>
        </div>

        <div style="margin-top: 3rem;">
          <h2>Lista de Perros</h2>
          <ul class="dogs-list" id="dogs-list">
            <!-- Dogs will be loaded here -->
          </ul>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  let adminPassword = "";

  const loginSection = document.getElementById("login-section");
  const adminPanel = document.getElementById("admin-panel");
  const loginBtn = document.getElementById("login-btn");
  const logoutBtn = document.getElementById("logout-btn");
  const passwordInput = document.getElementById("admin-password") as HTMLInputElement;
  const authMessage = document.getElementById("auth-message");
  const adminMessage = document.getElementById("admin-message");
  const dogForm = document.getElementById("dog-form") as HTMLFormElement;
  const dogsList = document.getElementById("dogs-list");
  const formTitle = document.getElementById("form-title");
  const dogIdInput = document.getElementById("dog-id") as HTMLInputElement;
  const cancelBtn = document.getElementById("cancel-btn");
  const imageFilesInput = document.getElementById("image-files") as HTMLInputElement;
  const imagePreview = document.getElementById("image-preview");
  const existingImagesSection = document.getElementById("existing-images-section");
  const existingImagesContainer = document.getElementById("existing-images");
  const deleteImagesLegend = document.getElementById("delete-images-legend");
  
  let currentDogImages: string[] = [];
  let pendingImageDeletes = new Set<string>();

  function getAuthHeaders(withJson = false): Record<string, string> {
    return {
      ...(withJson ? { "Content-Type": "application/json" } : {}),
      "X-Admin-Password": adminPassword,
    };
  }

  function parseCommaSeparated(value: string): string[] {
    return value
      .split(",")
      .map((item) => item.trim())
      .filter((item) => item);
  }

  function resetDogForm() {
    dogForm.reset();
    dogIdInput.value = "";
    currentDogImages = [];
    pendingImageDeletes = new Set();
    if (imagePreview) imagePreview.innerHTML = "";
    if (existingImagesSection) existingImagesSection.style.display = "none";
    if (existingImagesContainer) existingImagesContainer.innerHTML = "";
    if (deleteImagesLegend) deleteImagesLegend.style.display = "none";
    if (formTitle) formTitle.textContent = "Agregar Nuevo Perro";
  }

  function renderExistingImages() {
    if (!existingImagesSection || !existingImagesContainer) return;

    existingImagesContainer.innerHTML = "";

    if (currentDogImages.length === 0) {
      existingImagesSection.style.display = "none";
      if (deleteImagesLegend) deleteImagesLegend.style.display = "none";
      return;
    }

    existingImagesSection.style.display = "block";

    currentDogImages.forEach((imageUrl: string) => {
      const isPendingDelete = pendingImageDeletes.has(imageUrl);

      const imageWrapper = document.createElement("div");
      imageWrapper.style.position = "relative";
      imageWrapper.style.border = "2px solid var(--border)";
      imageWrapper.style.borderRadius = "4px";
      imageWrapper.style.overflow = "hidden";

      const img = document.createElement("img");
      img.src = imageUrl;
      img.style.width = "100%";
      img.style.height = "120px";
      img.style.objectFit = "cover";
      img.style.display = "block";
      img.style.filter = isPendingDelete ? "grayscale(100%)" : "none";

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "×";
      deleteBtn.type = "button";
      deleteBtn.style.position = "absolute";
      deleteBtn.style.top = "4px";
      deleteBtn.style.right = "4px";
      deleteBtn.style.background = "#c33";
      deleteBtn.style.color = "white";
      deleteBtn.style.border = "none";
      deleteBtn.style.borderRadius = "50%";
      deleteBtn.style.width = "24px";
      deleteBtn.style.height = "24px";
      deleteBtn.style.cursor = "pointer";
      deleteBtn.style.fontSize = "18px";
      deleteBtn.style.lineHeight = "1";
      deleteBtn.style.display = "flex";
      deleteBtn.style.alignItems = "center";
      deleteBtn.style.justifyContent = "center";
      deleteBtn.style.zIndex = "2";
      deleteBtn.style.opacity = isPendingDelete ? "0" : "1";
      deleteBtn.style.pointerEvents = isPendingDelete ? "none" : "auto";

      deleteBtn.addEventListener("click", () => {
        pendingImageDeletes.add(imageUrl);
        renderExistingImages();
      });

      if (isPendingDelete) {
        const overlay = document.createElement("div");
        overlay.style.position = "absolute";
        overlay.style.inset = "0";
        overlay.style.background = "rgba(40, 40, 40, 0.6)";
        overlay.style.display = "flex";
        overlay.style.flexDirection = "column";
        overlay.style.alignItems = "center";
        overlay.style.justifyContent = "center";
        overlay.style.gap = "0.35rem";
        overlay.style.zIndex = "1";

        const pendingIcon = document.createElement("span");
        pendingIcon.textContent = "×";
        pendingIcon.style.fontSize = "1.35rem";
        pendingIcon.style.fontWeight = "700";
        pendingIcon.style.color = "#fff";
        pendingIcon.style.textShadow = "0 1px 2px rgba(0, 0, 0, 0.5)";

        const pendingText = document.createElement("small");
        pendingText.textContent = "Pendiente de eliminar";
        pendingText.style.fontWeight = "600";
        pendingText.style.color = "#fff";
        pendingText.style.background = "rgba(0, 0, 0, 0.35)";
        pendingText.style.padding = "0.2rem 0.35rem";
        pendingText.style.borderRadius = "4px";
        pendingText.style.textShadow = "0 1px 2px rgba(0, 0, 0, 0.5)";

        const undoBtn = document.createElement("button");
        undoBtn.type = "button";
        undoBtn.className = "btn btn-danger";
        undoBtn.textContent = "Deshacer";
        undoBtn.style.padding = "0.25rem 0.5rem";
        undoBtn.style.fontSize = "0.8rem";
        undoBtn.style.minWidth = "auto";

        undoBtn.addEventListener("click", () => {
          pendingImageDeletes.delete(imageUrl);
          renderExistingImages();
        });

        overlay.appendChild(pendingIcon);
        overlay.appendChild(pendingText);
        overlay.appendChild(undoBtn);
        imageWrapper.appendChild(overlay);
      }

      imageWrapper.appendChild(img);
      imageWrapper.appendChild(deleteBtn);
      existingImagesContainer.appendChild(imageWrapper);
    });

    if (deleteImagesLegend) {
      deleteImagesLegend.style.display = pendingImageDeletes.size > 0 ? "block" : "none";
    }
  }

  // Image preview functionality
  imageFilesInput?.addEventListener("change", () => {
    if (!imagePreview) return;

    imagePreview.innerHTML = "";
    const files = imageFilesInput.files;

    if (files) {
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const reader = new FileReader();

        reader.onload = (e) => {
          const img = document.createElement("img");
          img.src = e.target?.result as string;
          img.style.width = "100%";
          img.style.height = "100px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "4px";
          img.style.border = "2px solid var(--border)";
          imagePreview.appendChild(img);
        };

        if (file) reader.readAsDataURL(file);
      }
    }
  });

  // Check if already logged in
  const savedPassword = sessionStorage.getItem("adminPassword");
  if (savedPassword) {
    adminPassword = savedPassword;
    validateAndShowAdminPanel();
  }

  loginBtn?.addEventListener("click", async () => {
    adminPassword = passwordInput.value;
    if (adminPassword) {
      await validateAndShowAdminPanel();
    } else {
      showAuthMessage("Por favor ingrese una contraseña", "error");
    }
  });

  logoutBtn?.addEventListener("click", () => {
    adminPassword = "";
    sessionStorage.removeItem("adminPassword");
    if (loginSection && adminPanel) {
      loginSection.style.display = "block";
      adminPanel.style.display = "none";
    }
    if (passwordInput) passwordInput.value = "";
  });

  function showAdminPanel() {
    if (loginSection && adminPanel) {
      loginSection.style.display = "none";
      adminPanel.style.display = "block";
    }
    loadDogs();
  }

  async function validateAndShowAdminPanel() {
    try {
      const response = await fetch("/api/auth/check", {
        method: "POST",
        headers: {
          "X-Admin-Password": adminPassword,
        },
      });

      if (!response.ok) {
        sessionStorage.removeItem("adminPassword");
        showAuthMessage("Contraseña incorrecta", "error");
        return;
      }

      sessionStorage.setItem("adminPassword", adminPassword);
      showAuthMessage("", "success");
      showAdminPanel();
    } catch (error) {
      showAuthMessage("No se pudo validar la contraseña", "error");
    }
  }

  async function uploadSelectedImages() {
    const imageFiles = imageFilesInput?.files;
    if (!imageFiles || imageFiles.length === 0) return [];

    const uploadFormData = new FormData();
    for (let i = 0; i < imageFiles.length; i++) {
      const file = imageFiles[i];
      if (file) uploadFormData.append("images", file);
    }

    const uploadResponse = await fetch("/api/upload", {
      method: "POST",
      headers: getAuthHeaders(),
      body: uploadFormData,
    });

    if (!uploadResponse.ok) {
      const error = await uploadResponse.json().catch(() => null);
      throw new Error(error?.error || "Error al subir imágenes");
    }

    const result = await uploadResponse.json();
    return result.urls || [];
  }

  function buildDogPayload(formData: FormData, uploadedUrls: string[]) {
    const data: any = {};
    const keptExistingImages = currentDogImages.filter(
      (imageUrl) => !pendingImageDeletes.has(imageUrl),
    );

    formData.forEach((value, key) => {
      if (key === "healthConditions" && value) {
        data[key] = parseCommaSeparated(value as string);
      } else if (key === "images" && value) {
        const urlImages = parseCommaSeparated(value as string);
        data[key] = [...keptExistingImages, ...urlImages, ...uploadedUrls];
      } else if (key === "vaccinated" || key === "sterilized") {
        data[key] = (document.getElementById(key) as HTMLInputElement).checked;
      } else if (key === "age") {
        data[key] = parseInt(value as string);
      } else {
        data[key] = value;
      }
    });

    if (!data.images || data.images.length === 0) {
      data.images = [...keptExistingImages, ...uploadedUrls];
    }

    return data;
  }

  function fillDogForm(dog: any) {
    dogIdInput.value = dog._id;
    (document.getElementById("name") as HTMLInputElement).value = dog.name;
    (document.getElementById("breed") as HTMLInputElement).value = dog.breed;
    (document.getElementById("age") as HTMLInputElement).value = dog.age;
    (document.getElementById("gender") as HTMLSelectElement).value = dog.gender;
    (document.getElementById("size") as HTMLSelectElement).value = dog.size;
    (document.getElementById("status") as HTMLSelectElement).value = dog.status;
    (document.getElementById("description") as HTMLTextAreaElement).value =
      dog.description;
    (document.getElementById("personality") as HTMLTextAreaElement).value =
      dog.personality || "";
    (document.getElementById("specialCare") as HTMLTextAreaElement).value =
      dog.specialCare || "";
    (document.getElementById("healthConditions") as HTMLInputElement).value =
      dog.healthConditions.join(", ");
    (document.getElementById("vaccinated") as HTMLInputElement).checked =
      dog.vaccinated;
    (document.getElementById("sterilized") as HTMLInputElement).checked =
      dog.sterilized;

    currentDogImages = [...dog.images];
  pendingImageDeletes = new Set();
    renderExistingImages();
    (document.getElementById("images") as HTMLInputElement).value = "";

    if (formTitle) formTitle.textContent = "Editar Perro";
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function showAuthMessage(message: string, type: "success" | "error") {
    if (authMessage) {
      authMessage.className = type;
      authMessage.textContent = message;
    }
  }

  function showAdminMessage(message: string, type: "success" | "error") {
    if (adminMessage) {
      adminMessage.className = type;
      adminMessage.textContent = message;
      setTimeout(() => {
        adminMessage.textContent = "";
        adminMessage.className = "";
      }, 3000);
    }
  }

  async function loadDogs() {
    try {
      const response = await fetch("/api/dogs");
      if (!response.ok) {
        const errorData = await response.json().catch(() => null);
        throw new Error(errorData?.error || "Error al cargar los perros");
      }

      const dogs = await response.json();
      if (!Array.isArray(dogs)) {
        throw new Error("Formato de respuesta inválido");
      }

      if (dogsList) {
        dogsList.innerHTML = dogs
          .map(
            (dog: any) => `
          <li>
            <div>
              <strong>${dog.name}</strong> - ${dog.breed} -
              <span class="dog-status status-${dog.status}">
                ${dog.status === "available" ? "Disponible" : dog.status === "adopted" ? "Adoptado" : dog.status === "in_treatment" ? "En Tratamiento" : "Reservado"}
              </span>
            </div>
            <div class="dog-actions">
              <button class="btn" data-action="edit" data-id="${dog._id}">Editar</button>
              <button class="btn btn-danger" data-action="delete" data-id="${dog._id}">Eliminar</button>
            </div>
          </li>
        `,
          )
          .join("");
      }
    } catch (error) {
      const message = error instanceof Error ? error.message : "Error al cargar los perros";
      showAdminMessage(message, "error");
    }
  }

  dogForm?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(dogForm);
    let uploadedUrls: string[] = [];

    try {
      uploadedUrls = await uploadSelectedImages();
    } catch (error) {
      const message = error instanceof Error ? error.message : "Error al subir imágenes";
      showAdminMessage(message, "error");
      return;
    }

    const data = buildDogPayload(formData, uploadedUrls);

    const dogId = dogIdInput.value;
    const url = dogId ? `/api/dogs/${dogId}` : "/api/dogs";
    const method = dogId ? "PUT" : "POST";

    try {
      const response = await fetch(url, {
        method,
        headers: getAuthHeaders(true),
        body: JSON.stringify(data),
      });

      if (response.ok) {
        showAdminMessage(
          dogId ? "Perro actualizado correctamente" : "Perro agregado correctamente",
          "success",
        );
        resetDogForm();
        loadDogs();
      } else {
        const error = await response.json();
        showAdminMessage(error.error || "Error al guardar el perro", "error");
      }
    } catch (error) {
      showAdminMessage("Error al guardar el perro", "error");
    }
  });

  cancelBtn?.addEventListener("click", () => {
    resetDogForm();
  });

  async function editDog(id: string) {
    try {
      const response = await fetch(`/api/dogs/${id}`);
      const dog = await response.json();

      fillDogForm(dog);
    } catch (error) {
      showAdminMessage("Error al cargar el perro", "error");
    }
  }

  async function deleteDog(id: string) {
    if (!confirm("¿Estás seguro de que quieres eliminar este perro?")) {
      return;
    }

    try {
      const response = await fetch(`/api/dogs/${id}`, {
        method: "DELETE",
        headers: getAuthHeaders(),
      });

      if (response.ok) {
        showAdminMessage("Perro eliminado correctamente", "success");
        loadDogs();
      } else {
        const error = await response.json();
        showAdminMessage(error.error || "Error al eliminar el perro", "error");
      }
    } catch (error) {
      showAdminMessage("Error al eliminar el perro", "error");
    }
  }

  dogsList?.addEventListener("click", async (event) => {
    const target = event.target as HTMLElement;
    const button = target.closest("button[data-action][data-id]") as HTMLButtonElement;
    if (!button) return;

    const action = button.dataset.action;
    const id = button.dataset.id;
    if (!id) return;

    if (action === "edit") {
      await editDog(id);
    } else if (action === "delete") {
      await deleteDog(id);
    }
  });
</script>
